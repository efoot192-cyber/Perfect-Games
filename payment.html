<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Perfect Store - Ø§Ù„Ø¯ÙØ¹</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="firebase.js"></script>

<style>
body {
  background:#0b0f1a;
  color:#fff;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}

.container {
  background:#12182b;
  border-radius:15px;
  box-shadow:0 0 30px rgba(0,0,0,0.7);
  width:400px;
  max-width:95%;
  overflow:hidden;
}

.game-info {
  display:flex;
  padding:20px;
  gap:15px;
  border-bottom:1px solid #2e3b5c;
  align-items:center;
}

.game-info img {
  width:100px;
  height:100px;
  border-radius:10px;
  object-fit:cover;
}

.game-details {
  flex:1;
}

.game-details h2 {
  margin:0;
  font-size:20px;
  color:#ffcc00;
}

.game-details p {
  margin:5px 0;
  color:#ccc;
  font-size:16px;
}

.price {
  font-weight:bold;
  font-size:18px;
  color:#4da3ff;
  margin-top:5px;
}

.payment-section {
  padding:20px;
  display:flex;
  flex-direction:column;
  gap:12px;
}

input {
  padding:12px;
  border-radius:8px;
  border:none;
  background:#1b2340;
  color:white;
  font-size:16px;
}

input::placeholder {
  color:#7a8ca2;
}

button {
  padding:12px;
  background:#2e7bff;
  border:none;
  border-radius:8px;
  color:white;
  font-size:16px;
  cursor:pointer;
  margin-top:10px;
  transition:0.2s;
}

button:hover { background:#4da3ff; }

#successBox {
  display:none;
  margin:20px;
  padding:15px;
  background:#1c3e1c;
  border-radius:8px;
  color:#b6ffb6;
  font-weight:bold;
  text-align:center;
}
</style>
</head>
<body>

<div class="container">
  <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© -->
  <div class="game-info">
    <img id="gameImg" src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©">
    <div class="game-details">
      <h2 id="gameName">...</h2>
      <p>Ø§Ù„Ø³Ø¹Ø±:</p>
      <p class="price" id="gamePrice">0$</p>
    </div>
  </div>

  <!-- Ù‚Ø³Ù… Ø§Ù„Ø¯ÙØ¹ -->
  <div class="payment-section">
    <input id="cardNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©">
    <input id="cvv" placeholder="CVV">
    <input id="pin" placeholder="PIN">
    <button onclick="pay()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹</button>
  </div>

  <div id="successBox">ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰<br>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù† Ù…ÙƒØªØ¨ØªÙƒ.</div>
</div>

<script>
const gameId = localStorage.getItem("buyGame");
const gameNameEl = document.getElementById("gameName");
const gamePriceEl = document.getElementById("gamePrice");
const gameImgEl = document.getElementById("gameImg");
const successBox = document.getElementById("successBox");

// ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
async function loadGame(){
  if(!gameId) return;
  const snap = await db.ref("games/"+gameId).once("value");
  const game = snap.val();
  if(!game) return;

  gameNameEl.innerText = game.name;
  gamePriceEl.innerText = game.price + "$";
  gameImgEl.src = game.coverImage || "placeholder.png";
}

loadGame();

async function pay(){
  try{
    const uid = localStorage.getItem("uid");
    if(!uid){ alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹"); location="auth.html"; return; }

    const card = document.getElementById("cardNumber").value.replace(/\s|-/g,"").trim();
    const cvv = document.getElementById("cvv").value.trim();
    const pin = document.getElementById("pin").value.trim();
    if(!card || !cvv || !pin){ alert("Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„"); return; }

    // ØªØ­Ù‚Ù‚ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
    const usersSnap = await db.ref("users").once("value");
    let bankUserKey = null;
    let bankUserData = null;
    usersSnap.forEach(uSnap=>{
      const user = uSnap.val();
      if((user.cardNumber||"").replace(/\s|-/g,"")===card &&
         String(user.cvv)===cvv &&
         String(user.pin)===pin){
        bankUserKey = uSnap.key;
        bankUserData = user;
      }
    });

    if(!bankUserKey){ alert("Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©"); return; }

    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
    const gameSnap = await db.ref("games/"+gameId).once("value");
    const game = gameSnap.val();
    if(!game){ alert("Ø§Ù„Ù„Ø¹Ø¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©"); return; }

    const price = Number(game.price);
    if(bankUserData.balance < price){ alert("Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ"); return; }

    // Ø®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯
    await db.ref("users/"+bankUserKey).update({ balance: bankUserData.balance - price });

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    await db.ref("usersperfect/"+uid+"/gamesOwned/"+gameId).set({
      purchasedAt: Date.now(),
      cardUsed: card.slice(-4),
      fileName: game.downloadUrl || game.fileName
    });

    // Ø³Ø¬Ù„ Ø§Ù„Ø´Ø±Ø§Ø¡
    const historyId = "h_"+Date.now();
    await db.ref("users/"+uid+"/history/"+historyId).set({
      gameName: game.name,
      price: price,
      date: Date.now()
    });

    successBox.style.display = "block";
    document.querySelectorAll("input, button").forEach(el=>el.style.display="none");

  }catch(err){
    console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯ÙØ¹:", err);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¯ÙØ¹ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† console");
  }
}
</script>
</body>
</html>